<html>

<head>
    <title>Deployment Manager UI</title>

    <link rel="stylesheet" href="lib/bootstrap-4.0.0.min.css">
    <style>
    body{
        padding: 10px;
    }
    .badge{
        margin: 5px 0 5px 0;
    }
    .borderless td, .borderless th {
        border: none;
        /*border-left: solid 1px gray;*/
        border-bottom: solid 1px gray;
    }
    .consolas{
        font-family: Consolas, monaco, monospace;
        font-size: small;
    }
    .logerror{
        background-color: #ff000024;
    }
    .tag + .tag{
        margin-left: 5px;
    }
    .submit{
        margin-bottom: 10px;
    }
    .taskArea {
        padding: 5px;
        background-color: aliceblue;
        border: 0;
        min-width: 100%;
        height:10em;
    }
    .taskDescrResp {
        margin-top: 10px;
        margin-bottom: 0;
    }

    </style>

    <script src="lib/axios.min.js"></script>
    <script src="lib/vue.js"></script>
    <script src="lib/jquery-3.2.1.slim.min.js"></script>
    <script src="lib/popper-1.12.9.min.js"></script>
    <script src="lib/bootstrap-4.0.0.min.js"></script>
    <script src="lib/moment.min.js"></script>
</head>

<body>
    <div id="submit" class="submit">

        <div id="accordion">
            <div class="card">
                <div style="padding: 0px" class="card-header" id="headingOne">
                    <h5 class="mb-0">
                        <button class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne" v-on:click="retrieveTaskLocal()">Submit Task</button>
                    </h5>
                </div>

                <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
                    <div class="card-body">
                        <p><textarea id="taskArea" class="card card-body consolas taskArea" v-model="taskDescr" oninput='this.style.height = "";this.style.height = this.scrollHeight + "px"' onclick='this.style.height = "";this.style.height = this.scrollHeight + "px"'>{{taskDescr}}</textarea></p>
                        <button type="button" v-on:click="submitTask()" class="btn btn-outline-dark btn-sm">Submit</button>
                        <div class="consolas taskDescrResp"><div v-for="(v, k) in taskDescrResp">{{k}}: {{v}}</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h4>TARGETS</h4>
    <table id="app" class="table table-sm borderless">
        <tbody>
        <tr v-for="(target, targetID) in targets"><td>
            <h5>{{targetID}} <span v-for="tag in target.Tags" class="badge badge-secondary tag">{{tag}}</span>
                <button type="button" v-on:click="fetchLogs(targetID)" class="btn btn-outline-dark btn-sm float-right">Request Logs</button></h5>

            <div v-for="task in sortTasks(target.Tasks)" class="accordion" id="accordionExample">
                <div class="card">
                    <div style="padding: 0px" class="card-header" v-bind:id="'heading-'+targetID+'-'+task.id">
                        <h5 class="mb-0">
                            <button class="w-100 btn btn-link collapsed" type="button" data-toggle="collapse" v-bind:data-target="'#collapse-'+targetID+'-'+task.id" aria-expanded="false" v-bind:aria-controls="'collapse-'+targetID+'-'+task.id">
                                <span class="float-left">Task {{ task.id }}</span> <span class="badge badge-light float-right">{{formatTime(task.value.Updated)}}</span>
                            </button>
                        </h5>
                    </div>

                    <div v-bind:id="'collapse-'+targetID+'-'+task.id" class="collapse" v-bind:aria-labelledby="'heading-'+targetID+'-'+task.id" data-parent="#accordionExample">
                        <div class="card-body">
                            <div v-for="(stage, name) in task.value.Stages">
                            <template v-if="stage.Logs">
                                <span class="badge badge-primary">{{name}}</span>
                                <div>
                                    <div class="consolas" v-for="log in stage.Logs.SYS">{{formatTime(log.Time)}} &nbsp; {{log.Output}}</div>
                                    <div style="margin-left: 1em;" v-for="(logs, type) in stage.Logs">
                                        <template v-if="type !=='SYS'">
                                        <span class="badge badge-secondary">{{type}}</span>
                                        <div v-bind:class="{logerror:log.Error}" class="consolas" v-for="log in logs">
                                            {{formatTime(log.Time)}} &nbsp; {{log.Output}}
                                        </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </td></tr>
        </tbody>
    </table>

    <script>

        var app = new Vue({
            el: '#app',
            data: {
                targets: {}
            },
            methods: {
                fetchLogs: function (id) {
                    axios.put('http://localhost:8080/targets/'+id+'/logs')
                        .then(function (response) {
                            console.log(response.data.message);
                        })
                        .catch(function (error) {
                            alert(error);
                        });
                },
                formatTime: function (unix) {
                    return moment.unix(unix/1e9).format('YYYY-MM-DD H:mm:ss');
                },
                sortTasks: function (dict) {
                    var sorted = [];
                    for(var key in dict) {
                        sorted[sorted.length] = {"id": key, "value": dict[key]};
                    }

                    function compare(a,b) {
                        if (a.value.Updated < b.value.Updated)
                            return -1;
                        if (a.value.Updated > b.value.Updated)
                            return 1;
                        return 0;
                    }

                    return sorted.sort(compare);
                }
            }
        });

        var submit = new Vue({
            el: '#submit',
            data: {
                taskDescr: "task description in YAML or JSON",
                taskDescrResp: {}
            },
            methods: {
                saveTaskLocal: function () {

                },
                retrieveTaskLocal: function () {
                    console.log("retrieveTaskLocal");
                    this.taskDescr = localStorage.getItem("taskDescr");
                },
                submitTask: function(){
                    console.log("Submitting task.");
                    console.log(this.taskDescr);
                    localStorage.setItem("taskDescr",this.taskDescr);
                    axios.post('http://localhost:8080/tasks', this.taskDescr)
                            .then(function (response) {
                                console.log(response);
                                submit.taskDescrResp = response.data.DeploymentInfo;
                            })
                            .catch(function (error) {
                                console.log(error);
                                alert(error.response.data.error);
                            });
                }
            }
        });

        function view(targets){
            app.targets = targets;
        }


        function getTargets() {
            axios.get('http://localhost:8080/targets')
                    .then(function (response) {
                        view(response.data);
                    })
                    .catch(function (error) {
                        // handle error
                        console.log(error);
                        setTimeout(function () {
                            getTargets();
                        }, 5000);
                    })
                    .then(function () {

                    });
        }

        function listen() {
            if (!("WebSocket" in window)) {
                alert("WebSocket is not supported by your Browser!");
                return;
            }

            var ws = new WebSocket("ws://localhost:8080/ws");
            ws.onopen = function () {
                console.log("Socket connected.");
                document.body.style.backgroundColor = "#fff";
                getTargets();
            }
            ws.onmessage = function (event) {
                // console.log(event.data);
                var obj = JSON.parse(event.data);
                view(obj);
            }
            ws.onclose = function () {
                console.log("Socket disconnected.");
                document.body.style.backgroundColor = "#fcc";
                setTimeout(function () {
                    listen();
                }, 5000);
            };

        }

        getTargets();
        listen();

    </script>

</body>

</html>